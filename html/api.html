<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>The API &mdash; NCPA 1.7.2 documentation</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-3.1.0/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-3.1.0/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.7.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="NCPA 1.7.2 documentation" href="index.html" />
    <link rel="next" title="Active Checks" href="active.html" />
    <link rel="prev" title="Configuration" href="configuration.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          NCPA</a>
        <span class="navbar-text navbar-version pull-left"><b>1.7</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="changes.html">1.8.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="changes.html#id2">1.7.2 - 08/28/2014</a></li>
<li class="toctree-l1"><a class="reference internal" href="changes.html#id3">1.7.1 - 08/19/2014</a></li>
<li class="toctree-l1"><a class="reference internal" href="changes.html#id4">1.7.0 - 07/29/2014</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">The API</a></li>
<li class="toctree-l1"><a class="reference internal" href="active.html">Active Checks</a></li>
<li class="toctree-l1"><a class="reference internal" href="passive.html">Passive Checks</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">The API</a><ul>
<li><a class="reference internal" href="#looking-at-the-tree">Looking at the tree</a></li>
<li><a class="reference internal" href="#accessing-specific-items-in-the-tree">Accessing specific items in the tree</a></li>
<li><a class="reference internal" href="#getting-nagios-return-results">Getting Nagios return results</a></li>
<li><a class="reference internal" href="#using-nagios-plugins">Using Nagios Plugins</a></li>
<li><a class="reference internal" href="#api-services">API/Services</a><ul>
<li><a class="reference internal" href="#monitoring-services-with-the-api">Monitoring Services With the API</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="configuration.html" title="Previous Chapter: Configuration"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm">&laquo; Configuration</span>
    </a>
  </li>
  <li>
    <a href="active.html" title="Next Chapter: Active Checks"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm">Active Checks &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="_sources/api.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="the-api">
<span id="introduction-api"></span><h1>The API<a class="headerlink" href="#the-api" title="Permalink to this headline">¶</a></h1>
<p>The NCPA API may seem complex but it is actually very simple. NCPA was designed to make it easy for administrators to set-up checks, troubleshoot, test new checks, and keep the options for running these checks very flexible.</p>
<p>Let&#8217;s try out a quick example to illustrate what this means. In these following examples I will be running my checks against &#8220;ncpaserver&#8221;, a fictitious server, so when addresses are used. Substitute the IP of your NCPA agent&#8217;s computer in for &#8220;ncpaserver&#8221; as well as your NCPA token for the token &#8220;nagios&#8221; that I use.</p>
<div class="section" id="looking-at-the-tree">
<h2>Looking at the tree<a class="headerlink" href="#looking-at-the-tree" title="Permalink to this headline">¶</a></h2>
<p>Open up your web browser, and navigate to:</p>
<div class="highlight-python"><div class="highlight"><pre>https://ncpaserver:5693/api/?token=nagios
</pre></div>
</div>
<p>This returns:</p>
<div class="highlight-python"><div class="highlight"><pre>--- snip ---
{
&quot;value&quot;: {
  &quot;root&quot;: {
    &quot;process&quot;: [],
    &quot;user&quot;: {
      &quot;count&quot;: 1,
      &quot;list&quot;: [
        &quot;nscott&quot;
      ]
    },
    &quot;memory&quot;: {
      &quot;swap&quot;: {
        &quot;used&quot;: [
          8245542912,
          &quot;b&quot;
        ],
--- snip ---
</pre></div>
</div>
<p>Looks like a very large list. If you take a close look at this list, you&#8217;ll see that amongst all the weird characters, there are actual numbers and descriptions of those numbers. This format is JSON, and those who are familiar with accessing APIs should be familiar with it.</p>
</div>
<div class="section" id="accessing-specific-items-in-the-tree">
<h2>Accessing specific items in the tree<a class="headerlink" href="#accessing-specific-items-in-the-tree" title="Permalink to this headline">¶</a></h2>
<p>So notice that there is a &#8220;memory&#8221; string. Let us amend our address a bit and see what comes out. Try:</p>
<div class="highlight-python"><div class="highlight"><pre>https://ncpaserver:5693/api/memory?token=nagios
</pre></div>
</div>
<p>This returns:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;snip&gt;
&quot;value&quot;: {
    &quot;memory&quot;: {
      &quot;swap&quot;: {
        &quot;used&quot;: [
          8202797056,
          &quot;b&quot;
        ],
        &quot;total&quot;: [
          17087578112,
          &quot;b&quot;
        ],
        &quot;percent&quot;: [
          48.0,
          &quot;%&quot;
        ],
        &quot;free&quot;: [
          8884781056,
          &quot;b&quot;
        ]
      },
      &quot;virtual&quot;: {
        &quot;available&quot;: [
&lt;snip&gt;
</pre></div>
</div>
<p>It cut out everything except all the items that had to do with memory. This is because the API is a tree we explicitly specified we wanted only the &#8220;memory&#8221; branch. We did this by adding the memory item in the URL.</p>
<div class="topic">
<p class="topic-title first">Accessible Branches</p>
<p>There are a few selectable branches in the main root of the tree, they are:</p>
<ul class="simple">
<li>memory</li>
<li>interface</li>
<li>agent</li>
<li>cpu</li>
<li>disk</li>
<li>agent</li>
<li>process</li>
<li>services</li>
</ul>
<p>These are meant to provide a platform independent way of accessing basic metrics on a server that are most often monitored. These are not run from plugins, these are built into the NCPA program itself.</p>
<p>Each of these branches contains its own metrics. Some of these metrics are enumerated upon NCPA server start-up. For instance, disks and interfaces will be enumerated and will be listed in this tree as well.</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">Accessing disks is indicated with the pipe | character, rather than the / or \ character to avoid escaping issues. Keep this in mind when writing queries. The | character is a special character in bash, so you will generally have to wrap it in single quotes when using it as an argument to avoid problems.</p>
</div>
<p>So hopefully, you&#8217;re noticing what&#8217;s going on here. To be overt, we can pare down the information to the actual metric we want in much the same way that we specify the file we want to a computer. We specify a path and then we access that file or directory. The individual metrics we wish to find (CPU Usage, Memory Usage, etc) are the files, while the general groupings (CPU, Memory) are the directories, in this analogy.</p>
<p>So now let us make a bigger leap and actually grab a specific memory metric. Let us grab the the percent of real memory used. If you look at the tree, you&#8217;d notice that the accessors URL is:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">api</span><span class="o">/</span><span class="n">memory</span><span class="o">/</span><span class="n">virtual</span><span class="o">/</span><span class="n">available</span>
</pre></div>
</div>
<p>So let us try plugging that in to our fictitious &#8220;ncpaserver&#8221;:</p>
<div class="highlight-python"><div class="highlight"><pre>https://ncpaserver:5693/api/memory/virtual/available?token=nagios
</pre></div>
</div>
<p>This returns:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">&quot;available&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="mi">1115017216</span><span class="p">,</span>
      <span class="s">&quot;b&quot;</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>So we see that we have exactly 1115017216 bytes of available RAM.</p>
<p>Take this method that we&#8217;ve done, going through the tree one thing at a time to find other metrics.</p>
</div>
<div class="section" id="getting-nagios-return-results">
<h2>Getting Nagios return results<a class="headerlink" href="#getting-nagios-return-results" title="Permalink to this headline">¶</a></h2>
<p>Well it&#8217;s good that we can pull these numbers, but it would pretty cool if we could turn these into Nagios return results. Now that we&#8217;ve spoke about accessing these items, lets talk about what we can do with these.</p>
<p>When you are working on a metric, rather than a group of metrics, you can turn it into a Nagios result very easily. The NCPA API supports quite a bit of specifications using GET (or POST) variables. To illustrate this let&#8217;s turn the above RAM number into a Nagios return results.</p>
<p>We are going to add <em>&amp;warning=60&amp;critical=80&amp;check=true</em> onto the end of the above URL:</p>
<div class="highlight-python"><div class="highlight"><pre>https://ncpaserver:5693/api/memory/virtual/available?token=nagios&amp;warning=1&amp;critical=2&amp;check=true
</pre></div>
</div>
<p>Returns:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">&quot;returncode&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s">&quot;stdout&quot;</span><span class="p">:</span> <span class="s">&quot;CRITICAL: Available was 1112682496.0b|&#39;available_0&#39;=1112682496.0b;1;2&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Using a GET request (we could also use POST, with the same variables) we were able to have the NCPA API dump this Nagios result formatted JSON output. We can clearly see the output which has a return code and the standard out that will give the status information for a service.</p>
<p>Bytes are kind of ugly though and I&#8217;d rather that number be in GB. So add &amp;unit=G to the end of the request:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">&quot;returncode&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&quot;stdout&quot;</span><span class="p">:</span> <span class="s">&quot;WARNING: Available was 1.114Gb|&#39;available_0&#39;=1.114Gb;1;2&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>That&#8217;s better, much more human readable.</p>
<div class="topic">
<p class="topic-title first">Nagios Check Result Specifiers</p>
<p>There are a couple things we can tack onto the request URL to get what we want out of our check</p>
<dl class="glossary docutils">
<dt id="term-check">check</dt>
<dd>Set to true if you&#8217;d like to result to be transformed into a check result rather than just raw data.</dd>
<dt id="term-warning">warning</dt>
<dd>Specify the Nagios warning threshold.*</dd>
<dt id="term-critical">critical</dt>
<dd>Specify the Nagios critical threshold.*</dd>
<dt id="term-unit">unit</dt>
<dd>Accepts K (for kilo), M (for mega), G (for giga) and T (for tera).</dd>
<dt id="term-delta">delta</dt>
<dd>There are some results that are counters. Specifically, the interface counters simply count the bytes that pass through the interface. Set delta=1 for the NCPA server to calculate the change in the counter divided by the amount of time that has past since last check to create bytes/sec.</dd>
</dl>
</div>
</div>
<div class="section" id="using-nagios-plugins">
<h2>Using Nagios Plugins<a class="headerlink" href="#using-nagios-plugins" title="Permalink to this headline">¶</a></h2>
<p>Using existing Nagios plugins is not an issue either. In fact we can list all the plugins that are installed on the system by accessing the address:</p>
<div class="highlight-python"><div class="highlight"><pre>https://ncpaserver:5693/api/agent/plugins
</pre></div>
</div>
<p>This returns:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">&quot;plugins&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s">&quot;check_msmq.vbs&quot;</span><span class="p">,</span>
      <span class="s">&quot;test.vbs&quot;</span><span class="p">,</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Which shows all of the plugins that are installed. Now if we want to execute those plugins, we follow the same logic as we did above (for the non-plugin metrics). One new introduction is for plugins that take arguments. Simply separate them with the forward slashes. So for instance, to pass one argument to my test.vbs script, I would call:</p>
<div class="highlight-python"><div class="highlight"><pre>https://ncpaserver:5693/api/agent/plugin/test.vbs/&quot;First Arg&quot;?token=nagios
</pre></div>
</div>
<p>Which shows us the output:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">&quot;returncode&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s">&quot;stdout&quot;</span><span class="p">:</span> <span class="s">&quot;This worked! First Arg</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Which is what our script is supposed to do, return 2 and print &#8220;This Worked!&#8221; along with the first argument.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For plugins, the Check Result Specified do not apply. The result specified will work only for NCPA tree results.</p>
</div>
</div>
<div class="section" id="api-services">
<h2>API/Services<a class="headerlink" href="#api-services" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Although the services tree changed in 1.7.0, backwards compatibility to the way the API worked in previous versions was added in 1.7.1 which allows old check_ncpa.py checks to work regardless of the version of the plugin script and the version of the NCPA agent installed.</p>
</div>
<p>The service tree has changed in NCPA 1.7.0 and now uses a more hybrid form of request. Like before, you can see the existing services and their current status by going to <tt class="docutils literal"><span class="pre">api/service</span></tt> but this is the end of the tree:</p>
<div class="highlight-python"><div class="highlight"><pre>https://ncpaserver:5693/api/services

{
    &quot;value&quot;: {
        &quot;services&quot;: {
            &quot;auditd&quot;: &quot;running&quot;,
            &quot;netfs&quot;: &quot;stopped&quot;,
            &quot;sshd&quot;: &quot;running&quot;,
            ...
        }
    }
}
</pre></div>
</div>
<p>Using the above example should give you a list of all the services on your system in alphabetical order. Now if you would like to see a specific service, such as <strong>sshd</strong> in our instance, try:</p>
<div class="highlight-python"><div class="highlight"><pre>https://ncpaserver:5693/api/services?service=sshd

or

(Deprecated) https://ncpaserver:5693/api/service/sshd

{
    &quot;value&quot;: {
        &quot;service&quot;: {
            &quot;sshd&quot;: &quot;running&quot;
        }
    }
}
</pre></div>
</div>
<p>This will filter the list of services down to the service specified, <strong>sshd</strong> by using the <em>service</em> paramter. The output also shows it&#8217;s current status (running or stopped). You can also filter by multiple services by adding multipe parameters to the request. If we would have done <tt class="docutils literal"><span class="pre">service=sshd&amp;service=auditd</span></tt> we would have got two services back. You can also filter by status using the <em>status</em> parameter.</p>
<div class="section" id="monitoring-services-with-the-api">
<h3>Monitoring Services With the API<a class="headerlink" href="#monitoring-services-with-the-api" title="Permalink to this headline">¶</a></h3>
<p>Now in order for us to check if the service is running and give us the normal Nagios output, use:</p>
<div class="highlight-python"><div class="highlight"><pre>https://ncpaserver:5693/api/service?service=sshd&amp;status=running&amp;check=true

or

(Deprecated) https://ncpaserver:5693/api/service/sshd/running

{
    &quot;value&quot;: {
        &quot;returncode&quot;: 0,
        &quot;stdout&quot;: &quot;OK: Service sshd is running&quot;
    }
}
</pre></div>
</div>
<p>Using this type of request on <tt class="docutils literal"><span class="pre">api/services</span></tt> is how you will check to see if a service is running or not. Notice that the <em>status</em> parameter is set to what the status should be when the check is executed. In other words, the check above would have returned a CRITICAL stdout if the <em>status</em> parameter was set to stopped since it was running when the check was performed.</p>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2013-2014, Nagios Enterprises LLC, Nicholas Scott.<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>